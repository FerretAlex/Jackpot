<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile — Jackpot</title>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            jp: {
              bg: "#F7F7F5",
              text: "#0F172A",
              muted: "#475569",
              card: "#FFFFFF",
              border: "rgba(15, 23, 42, 0.10)",
              gold: "#D4AF37",
              gold2: "#FFD36A",
              ink: "#111827"
            }
          },
          boxShadow: {
            soft: "0 12px 30px rgba(15, 23, 42, 0.08)",
            lift: "0 18px 40px rgba(15, 23, 42, 0.12)"
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background:
        radial-gradient(900px 450px at 80% 0%, rgba(212,175,55,0.14), transparent 60%),
        radial-gradient(700px 380px at 10% 10%, rgba(255,211,106,0.10), transparent 60%),
        radial-gradient(rgba(15,23,42,0.06) 1px, transparent 1px);
      background-size: auto, auto, 18px 18px;
      background-position: 0 0, 0 0, 0 0;
    }

    .chip-base {
      padding: 0.28rem 0.75rem;
      font-size: 0.8125rem;
      border-radius: 9999px;
      border: 1px solid rgba(15, 23, 42, 0.14);
      background: #fff;
      color: rgba(15, 23, 42, 0.72);
      cursor: pointer;
      transition: 0.16s ease;
      user-select: none;
    }
    .chip-base:hover {
      border-color: rgba(15, 23, 42, 0.22);
      color: rgba(15, 23, 42, 0.90);
      transform: translateY(-1px);
    }
    .chip-active {
      background: rgba(212,175,55,0.18);
      border-color: rgba(212,175,55,0.55);
      color: #111827;
    }
    .chip-disabled {
      cursor: default;
      opacity: .85;
      transform: none !important;
    }
  </style>
</head>

<body class="bg-jp-bg text-jp-text min-h-screen flex flex-col antialiased">
  <nav class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-jp-border">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="text-sm text-jp-muted hover:text-jp-text">← Back to users</a>

      <div class="flex items-center gap-4 text-sm">
        <a href="matches.html" class="text-jp-muted hover:text-jp-text">Chats</a>
        <button type="button" onclick="logout()" class="text-jp-muted hover:text-red-600">Log-out</button>
      </div>
    </div>
  </nav>

  <main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 py-6">
      <div class="flex items-end justify-between gap-4 mb-6">
        <div>
          <h1 class="text-xl font-semibold">My profile</h1>
        </div>
      </div>

      <!-- Header card -->
      <div class="bg-jp-card border border-jp-border shadow-soft rounded-2xl p-6 flex flex-col sm:flex-row sm:items-center sm:gap-6">
        <img id="avatar" src="default-avatar.png"
             class="w-24 h-24 rounded-xl object-cover border border-jp-border mb-4 sm:mb-0"
             alt="avatar" />

        <div class="flex-1">
          <p id="name" class="text-base font-semibold text-jp-text">Name</p>
          <p id="email" class="text-sm text-jp-muted">email@example.com</p>
          <p class="text-xs text-jp-muted pt-2">This information can't be changed.</p>
        </div>
      </div>

      <!-- Upload avatar -->
      <div class="mt-6 bg-jp-card border border-jp-border shadow-soft rounded-2xl p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-sm font-semibold text-jp-text">Update avatar</h2>
            <p class="text-xs text-jp-muted mt-1">Choose an image (jpg/png)</p>
          </div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-3">
          <input id="file" type="file" accept="image/*" class="text-sm text-jp-muted" />
          <button type="button" onclick="uploadAvatar()"
            class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-xs font-semibold
                   text-white bg-[#C9A227] border border-[rgba(15,23,42,0.10)]
                   hover:brightness-95 active:translate-y-px transition shadow-soft">
            Upload new photo
          </button>
        </div>

        <p id="msg" class="text-xs text-emerald-700 mt-3 hidden"></p>
        <p id="err" class="text-xs text-red-600 mt-3 hidden"></p>
      </div>

      <!-- Details -->
      <div class="mt-6 bg-jp-card border border-jp-border shadow-soft rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-base font-semibold text-jp-text flex items-center gap-2">
            <span class="w-2 h-2 rounded-full" style="background: rgba(212,175,55,0.9)"></span>
            Profile details
          </h2>

          <button id="editBtn" type="button"
            class="text-sm px-3 py-1.5 rounded-xl border border-jp-border text-jp-muted hover:text-jp-text hover:border-[rgba(15,23,42,0.18)] transition">
            Edit
          </button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <!-- Age -->
          <div>
            <label class="block text-sm text-jp-muted mb-1">Age</label>
            <input id="age" type="number" min="0"
              class="w-full rounded-lg border border-jp-border bg-white px-3 py-2 text-sm text-jp-text outline-none
                     focus:ring-2 focus:ring-[rgba(212,175,55,0.35)]" />
          </div>

          <!-- Gender -->
          <div>
            <label class="block text-sm text-jp-muted mb-1">Gender</label>
            <select id="gender"
              class="w-full rounded-lg border border-jp-border bg-white px-3 py-2 text-sm text-jp-text outline-none
                     focus:ring-2 focus:ring-[rgba(212,175,55,0.35)]">
              <option value="">—</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Prefer not to say</option>
            </select>
          </div>

          <!-- Faculty (YOUR BLOCK) -->
          <div>
            <label class="block text-sm text-jp-muted mb-1">Faculty</label>
            <select id="faculty"
                    class="w-full rounded-lg border border-jp-border bg-white px-3 py-2 text-sm text-jp-text outline-none
                           focus:ring-2 focus:ring-[rgba(212,175,55,0.35)]">
              <option value="">Select faculty</option>
              <option value="Engineering">Faculty of Civil and Mechanical Engineering</option>
              <option value="NaturalSciences">Faculty of Natural Sciences and Technology</option>
              <option value="IT">Faculty of Computer Science, Information Technology and Energy</option>
              <option value="Economics">Faculty of Engineering Economics and Management</option>
              <option value="Architecture">Institute of Architecture and Design</option>
              <option value="Business">Riga Business School</option>
              <option value="MaritimeAcademy">Latvian Maritime Academy of Riga Technical University</option>
              <option value="Liepaja">RTU Liepaja</option>
              <option value="Rezekne">RTU Rezekne</option>
            </select>
          </div>

          <!-- Course -->
          <div>
            <label class="block text-sm text-jp-muted mb-1">Course</label>
            <select id="course"
              class="w-full rounded-lg border border-jp-border bg-white px-3 py-2 text-sm text-jp-text outline-none
                     focus:ring-2 focus:ring-[rgba(212,175,55,0.35)]">
              <option value="">Select your course</option>
              <option value="1">Bachelor 1</option>
              <option value="2">Bachelor 2</option>
              <option value="3">Bachelor 3</option>
              <option value="4">Bachelor 4</option>
              <option value="5">Master 1</option>
              <option value="6">Master 2</option>
              <option value="7">PhD</option>
            </select>
          </div>
        </div>

        <!-- Interests -->
        <div class="mt-6">
          <p class="text-jp-muted text-xs uppercase tracking-wide mb-2">Interests</p>
          <div id="interestsBox" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- About -->
        <div class="mt-6">
          <p class="text-jp-muted text-xs uppercase tracking-wide mb-2">About me</p>
          <textarea id="about" rows="3"
            class="w-full rounded-lg border border-jp-border bg-white px-3 py-2 text-sm text-jp-text outline-none
                   focus:ring-2 focus:ring-[rgba(212,175,55,0.35)]"></textarea>
        </div>

        <!-- Buttons -->
        <div id="editButtons" class="hidden mt-6 flex gap-3">
          <button id="saveBtn" type="button"
            class="px-4 py-2 rounded-xl text-sm font-semibold text-white bg-[#C9A227]
                   hover:brightness-95 active:translate-y-px transition shadow-soft">
            Save
          </button>
          <button id="cancelBtn" type="button"
            class="px-4 py-2 rounded-xl text-sm font-semibold border border-jp-border text-jp-muted
                   hover:text-jp-text hover:border-[rgba(15,23,42,0.18)] transition">
            Cancel
          </button>
        </div>

        <p id="editMsg" class="text-xs mt-3 hidden"></p>
      </div>
    </div>
  </main>

  <footer class="mt-auto border-t border-jp-border bg-white/70 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-4 text-xs text-jp-muted flex items-center justify-between gap-3">
      <p>© <span id="year"></span> Jackpot</p>
      <p class="text-right">December, 2025</p>
    </div>
  </footer>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    const ALL_INTERESTS = ["sports","music","movies","BoardGaming","CompGaming","travel","food","astrology","science","art"];
    const INTEREST_LABELS = {
      sports: "Sport",
      music: "Music",
      movies: "Movies",
      BoardGaming: "Board games",
      CompGaming: "Computer games",
      travel: "Travel",
      food: "Food",
      astrology: "Astrology",
      science: "Science",
      art: "Art"
    };

    let editMode = false;
    let currentInterests = [];

    const el = (id) => document.getElementById(id);

    function showEditMsg(text, ok = null) {
      const m = el("editMsg");
      m.classList.remove("hidden", "text-red-600", "text-emerald-700", "text-jp-muted");
      if (ok === true) m.classList.add("text-emerald-700");
      else if (ok === false) m.classList.add("text-red-600");
      else m.classList.add("text-jp-muted");
      m.textContent = text;
    }

    function setEditing(on) {
      editMode = on;

      // enable/disable fields
      ["age","gender","faculty","course","about"].forEach(id => {
        const node = el(id);
        if (!node) return;
        node.disabled = !on;
        node.classList.toggle("opacity-80", !on);
      });

      // chips
      renderInterests();

      // buttons
      el("editButtons").classList.toggle("hidden", !on);
      el("editBtn").textContent = on ? "Cancel edit" : "Edit";

      if (!on) {
        el("editMsg").classList.add("hidden");
        el("editMsg").textContent = "";
      }
    }

    function ensureFacultyOption(value) {
      const select = el("faculty");
      if (!select || !value) return;

      const exists = Array.from(select.options).some(o => o.value === value);
      if (exists) return;

      // add unknown value as an option so it doesn't reset to ""
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = value;
      // put it after the first option
      select.insertBefore(opt, select.options[1] || null);
    }

    async function loadProfile() {
      const res = await fetch("/api/me", { headers: { "Authorization": "Bearer " + token } });
      if (res.status === 401) {
        localStorage.clear();
        window.location.href = "login.html";
        return;
      }

      const me = await res.json();

      el("name").textContent = me.name || "No name";
      el("email").textContent = me.email || "";
      el("avatar").src = me.avatar || "default-avatar.png";

      el("age").value = (me.age ?? "");
      el("gender").value = (me.gender ?? "");

      ensureFacultyOption(me.faculty);
      el("faculty").value = (me.faculty ?? "");

      el("course").value = (me.course ?? "");
      el("about").value = (me.about ?? "");

      currentInterests = Array.isArray(me.interests) ? me.interests : [];
      renderInterests();

      // default: view mode
      setEditing(false);
    }

    function renderInterests() {
      const box = el("interestsBox");
      box.innerHTML = "";

      ALL_INTERESTS.forEach(value => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.textContent = INTEREST_LABELS[value] || value;
        chip.className =
          "chip-base" +
          (currentInterests.includes(value) ? " chip-active" : "") +
          (!editMode ? " chip-disabled" : "");

        chip.addEventListener("click", () => {
          if (!editMode) return;
          if (currentInterests.includes(value)) {
            currentInterests = currentInterests.filter(x => x !== value);
            chip.classList.remove("chip-active");
          } else {
            currentInterests.push(value);
            chip.classList.add("chip-active");
          }
        });

        box.appendChild(chip);
      });

      const extra = currentInterests.filter(x => !ALL_INTERESTS.includes(x));
      extra.forEach(value => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.textContent = value;
        chip.className = "chip-base chip-active" + (!editMode ? " chip-disabled" : "");
        chip.addEventListener("click", () => {
          if (!editMode) return;
          currentInterests = currentInterests.filter(x => x !== value);
          chip.remove();
        });
        box.appendChild(chip);
      });
    }

    async function saveProfile() {
      showEditMsg("Saving...", null);

      const ageRaw = el("age").value.trim();
      const courseRaw = el("course").value.trim();

      const payload = {
        gender: el("gender").value || null,
        faculty: el("faculty").value || null,
        interests: currentInterests,
        about: el("about").value || ""
      };

      if (ageRaw !== "") payload.age = Number(ageRaw);
      if (courseRaw !== "") payload.course = Number(courseRaw);

      try {
        const res = await fetch("/api/update-profile", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch (_) {}

        if (!res.ok) {
          showEditMsg(`Save failed (${res.status}): ${data?.error || text || "No details"}`, false);
          return;
        }

        if (data?.status === "ok") {
          showEditMsg("Profile updated.", true);
        } else {
          showEditMsg("Saved.", true);
        }

        await loadProfile();
      } catch (e) {
        showEditMsg("Save failed: " + (e?.message || String(e)), false);
      }
    }

    async function uploadAvatar() {
      const fileInput = el("file");
      const msg = el("msg");
      const err = el("err");
      msg.classList.add("hidden");
      err.classList.add("hidden");

      if (!fileInput.files.length) {
        err.textContent = "Choose a file.";
        err.classList.remove("hidden");
        return;
      }

      const formData = new FormData();
      formData.append("avatar", fileInput.files[0]);

      const res = await fetch("/api/upload-avatar", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
      });

      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch (_) {}

      if (res.ok && data?.avatar) {
        el("avatar").src = data.avatar;
        msg.textContent = "Avatar updated.";
        msg.classList.remove("hidden");
      } else {
        err.textContent = data?.error || text || "Upload failed.";
        err.classList.remove("hidden");
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    // footer year
    const y = el("year");
    if (y) y.textContent = new Date().getFullYear();

    // wire buttons
    el("editBtn").addEventListener("click", () => {
      if (editMode) {
        // cancel edit
        loadProfile();
      } else {
        setEditing(true);
        showEditMsg("Editing enabled.", null);
      }
    });

    el("saveBtn").addEventListener("click", saveProfile);
    el("cancelBtn").addEventListener("click", loadProfile);

    // initial
    loadProfile();
  </script>
</body>
</html>
