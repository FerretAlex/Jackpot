<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Профиль — Mini Match</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">
<nav class="bg-white shadow-sm">
  <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="index.html" class="text-sm text-slate-600 hover:text-sky-600">← Назад к пользователям</a>
    <button onclick="logout()" class="text-sm text-slate-500 hover:text-red-500">Выйти</button>
  </div>
</nav>

<main class="flex-1">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-xl font-semibold text-slate-900 mb-4">Мой профиль</h1>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col sm:flex-row sm:items-center sm:space-x-6">
      <img id="avatar" src="default-avatar.png" class="w-24 h-24 rounded-xl object-cover border border-slate-200 mb-4 sm:mb-0" alt="avatar">
      <div class="flex-1 space-y-1">
        <p id="name" class="text-base font-semibold text-slate-900">Имя</p>
        <p id="email" class="text-sm text-slate-500">email@example.com</p>
        <p class="text-xs text-slate-400 pt-2">Эти данные хранятся в JSON-файле <code>database.json</code>. Подходит для учебных проектов и лабораторных.</p>
      </div>
    </div>

    <div class="mt-6 bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
      <h2 class="text-sm font-semibold text-slate-800 mb-3">Обновить аватар</h2>
      <p class="text-xs text-slate-500 mb-3">Выбери картинку (jpg/png), она сохранится в папке <code>uploads</code>, а путь запишется в JSON-базу.</p>

      <input id="file" type="file" class="text-xs text-slate-600 mb-3">
      <button onclick="uploadAvatar()" class="inline-flex items-center px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white text-xs font-medium rounded-lg">
        Загрузить новое фото
      </button>

      <p id="msg" class="text-xs text-emerald-600 mt-3 hidden"></p>
      <p id="err" class="text-xs text-red-500 mt-3 hidden"></p>
    </div>
  </div>
</main>

<script>
const token = localStorage.getItem("token");
if (!token) {
  window.location.href = "login.html";
}

async function loadProfile() {
  const res = await fetch("/api/me", {
    headers: { "Authorization": "Bearer " + token }
  });

  if (res.status === 401) {
    localStorage.clear();
    window.location.href = "login.html";
    return;
  }

  const me = await res.json();
  document.getElementById("name").textContent = me.name || "Без имени";
  document.getElementById("email").textContent = me.email;
  document.getElementById("avatar").src = me.avatar || "default-avatar.png";
}

async function uploadAvatar() {
  const fileInput = document.getElementById("file");
  const msg = document.getElementById("msg");
  const err = document.getElementById("err");
  msg.classList.add("hidden");
  err.classList.add("hidden");

  if (!fileInput.files.length) {
    err.textContent = "Выберите файл.";
    err.classList.remove("hidden");
    return;
  }

  const formData = new FormData();
  formData.append("avatar", fileInput.files[0]);

  const res = await fetch("/api/upload-avatar", {
    method: "POST",
    headers: { "Authorization": "Bearer " + token },
    body: formData
  });

  const data = await res.json();

  if (data.avatar) {
    document.getElementById("avatar").src = data.avatar;
    msg.textContent = "Аватар обновлён.";
    msg.classList.remove("hidden");
  } else if (data.error) {
    err.textContent = data.error;
    err.classList.remove("hidden");
  }
}

function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

loadProfile();
</script>
</body>
</html>
